apiVersion: apps/v1
kind: Deployment
metadata:
  name: recorder
  labels:
    app: radio-monitor
    component: recorder
spec:
  selector:
    matchLabels:
      app: radio-monitor
      component: recorder
  template:
    metadata:
      labels:
        app: radio-monitor
        component: recorder
    spec:
      initContainers:
      - name: create-sub-dirs
        image: busybox:stable
        command: ['sh', '-c', 'mkdir -p /mnt/3LO:ffmpeg /mnt/2BL:ffmpeg']
        volumeMounts:
        - name: audio
          mountPath: /mnt
      containers:
      - name: ffmpeg-3lo
        image: jrottenberg/ffmpeg:4.1-scratch
        args:
        # Input
        - -i
        - http://live-radio01.mediahubaustralia.com/3LRW/mp3/
        # Output
        - -c:a
        - mp3
        - -f
        - segment
        - -segment_time
        - '60'
        - -strftime
        - '1'
        - /mnt/3LO:ffmpeg/%Y-%m-%dT%H:%M:%SZ.mp3
        resources:
          limits:
            cpu: 60m
            memory: 50Mi
          requests:
            cpu: 60m
            memory: 50Mi
        volumeMounts:
        - name: audio
          mountPath: /mnt
      - name: ffmpeg-2bl
        image: jrottenberg/ffmpeg:4.1-scratch
        args:
        # Input
        - -i
        - https://live-radio01.mediahubaustralia.com/2LRW/mp3/
        # Output
        - -c:a
        - mp3
        - -f
        - segment
        - -segment_time
        - '60'
        - -strftime
        - '1'
        - /mnt/2BL:ffmpeg/%Y-%m-%dT%H:%M:%SZ.mp3
        resources:
          limits:
            cpu: 60m
            memory: 50Mi
          requests:
            cpu: 60m
            memory: 50Mi
        volumeMounts:
        - name: audio
          mountPath: /mnt
      volumes:
      - name: audio
        persistentVolumeClaim:
          claimName: audio
